{% extends 'base.html' %}
{% load markdown_extras mathfilters custom_filters static %}

{% block content %}
<head>
  <title>{{ benchmark.benchmark_name }}</title>
  <link rel="stylesheet" href="{% static 'prism/prism-tomorrow.css' %}">
</head>

<div class="container my-4">
  <!-- Header -->
  <section class="section-header mb-4">
    <div class="header-main">
      <h1 class="entity-title">{{ benchmark.benchmark_name }}</h1>
      <button class="copy-button" onclick="copyHiddenValue('copy-value')" aria-label="경로 복사">
        <img src="{% static 'svg/copy.svg' %}" alt="Copy" width="16" height="16">
      </button>
      <input type="hidden" id="copy-value" value="{{ benchmark.dataset_path }}">
    </div>
    <div class="header-meta">
      <div class="badge-group">
        {% for tag in benchmark.tag|split:"," %}
          <span class="badge-pill">{{ tag }}</span>
        {% endfor %}
      </div>
      <span class="meta-item">Author: {{ benchmark.author }}</span>
    </div>
  </section>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
    <li class="nav-item"><button class="nav-link {% if active_tab == 'readme' %}active{% endif %}"
         data-bs-toggle="tab" data-bs-target="#readme" type="button">README.md</button></li>
    <li class="nav-item"><button class="nav-link {% if active_tab == 'leader_board' %}active{% endif %}"
         data-bs-toggle="tab" data-bs-target="#leader_board" type="button">리더보드</button></li>
    <li class="nav-item"><button class="nav-link {% if active_tab == 'add_eval_result' %}active{% endif %}"
         data-bs-toggle="tab" data-bs-target="#add_eval_result" type="button">평가 결과 등록</button></li>
  </ul>

  <div class="tab-content">
    <!-- README -->
    <div class="tab-pane fade {% if active_tab == 'readme' %}show active{% endif %} markdown p-3"
         style="max-height:70vh;overflow:auto;" id="readme">
      <div class="markdown-body">{{ readme|mark|safe }}</div>
    </div>

    <!-- 리더보드 -->
    <div class="tab-pane fade {% if active_tab == 'leader_board' %}show active{% endif %}"
         id="leader_board">
      <div class="label-card mb-4">
        <div class="label-card-header">
          <h5 class="mb-0">평가 결과</h5>
        </div>
        <div class="label-card-body p-0">
          <div class="overflow-x-auto">
            <table class="manager-table mb-0">
              <thead>
                <tr>
                  <th>모델</th>
                  {% for head in headers %}<th>{{ head }}</th>{% endfor %}
                  <th>미리보기</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rows %}
                <tr tabindex="0">
                  <td>
                    <div x-data="{open:false}" @click="open=!open" class="cursor-pointer">
                      <div :class="open? '' : 'text-truncate'">{{ row.model_name }}</div>
                    </div>
                  </td>
                  {% for head in headers %}
                  <td>
                    <div x-data="{open:false}" @click="open=!open" class="cursor-pointer">
                      <div :class="open? '' : 'text-truncate'">{{ row|dict_get:head }}</div>
                    </div>
                  </td>
                  {% endfor %}
                  <td>
                    <a href="{% url 'model_dashboard:eval_viewer' benchmark.id row.model_id %}"
                       class="hit-btn-solid-primary btn-sm">미리보기</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 평가 결과 등록 -->
    <div class="tab-pane fade {% if active_tab == 'add_eval_result' %}show active{% endif %}"
         id="add_eval_result">
      {% include 'model_dashboard/add_result.html' %}
    </div>
  </div>
      <!-- 수정 / 삭제 버튼 -->
      {% if request.user == benchmark.author %}
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button class="hit-btn-outline-dark btn-sm modify">수정</button>
        <button class="hit-btn-outline-red btn-sm delete" data-uri="{% url 'model_dashboard:delete_dashboard' benchmark.id %}">
          삭제
        </button>
      </div>
      {% endif %}
</div>

{% block script %}
<script src="{% static 'cdn.min.js' %}"></script>
<script src="{% static 'bootstrap.bundle.min.js' %}"></script>
<script>
  document.querySelectorAll('.modify').forEach(btn=>
    btn.addEventListener('click', ()=>confirm('아직 구현되지 않았습니다~'))
  );
  document.querySelectorAll('.delete').forEach(btn=>
    btn.addEventListener('click', ()=>{
      if(confirm('정말로 삭제하시겠습니까?')){
        location.href = btn.dataset.uri;
      }
    })
  );
  function copyHiddenValue(id){
    navigator.clipboard.writeText(document.getElementById(id).value)
      .then(()=>alert('클립보드에 복사되었습니다.'));
  }
</script>
{% endblock %}
{% endblock %}
