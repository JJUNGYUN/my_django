{# model_dashboard/add_result.html #}
{% load static markdown_extras custom_filters mathfilters %}

<div class="container my-4">
  <div class="label-card mx-auto" style="max-width:720px;">
    <div class="label-card-header">
      <h5 class="mb-0 text-center">평가 결과 추가</h5>
    </div>
    <div class="label-card-body">
      <form method="post"
            action="{% url 'model_dashboard:add_eval_result' benchmark.id %}"
            enctype="multipart/form-data"
            class="needs-validation"
            novalidate>
        {% csrf_token %}
        {% include "form_errors.html" %}

        <input type="hidden" name="benchmark_name" value="{{ benchmark.benchmark_name }}">

        <div class="mb-3">
          <label for="model-input" class="form-label">모델 이름</label>
          <input type="text" id="model-input" name="model_name"
                 class="form-control" placeholder="모델 탭의 모델을 입력" required>
          <div class="invalid-feedback">모델 이름을 입력해주세요.</div>
        </div>

        <div class="mb-3">
          <label for="json_file" class="form-label">JSON 파일 업로드 (Optional)</label>
          <input type="file" id="json_file" name="json_file" accept=".json" class="form-control">
          <div class="form-text">업로드 시 하단 입력 필드는 무시됩니다.</div>
        </div>

        <div class="mb-3">
          <label for="evaluate_result" class="form-label">샘플 데이터 <small class="text-muted">(Optional)</small></label>
          <textarea id="evaluate_result" name="evaluate_result"
                    class="form-control" rows="5"
                    placeholder='예: {"1": {"입력":"1+1=","출력":"2"}}'></textarea>
          <div class="invalid-feedback">유효한 JSON 형식으로 입력해주세요.</div>
        </div>

        <hr>

        {% for head in headers %}
        <div class="mb-3">
          <label class="form-label">{{ head }}</label>
          <input type="text"
                 name="{{ head }}_score"
                 class="form-control"
                 placeholder="Enter {{ head }} value"
                 value="{{ scores|get_item:head|default_if_none:'' }}">
        </div>
        {% endfor %}

        <div class="text-end">
          <button type="submit" class="hit-btn-solid-primary">등록</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% block script %}
<script src="{% static 'dashboard/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'dashboard/jquery-ui.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'dashboard/jquery-ui.css' %}">

<script>
  // Bootstrap form validation
  (function(){
    'use strict';
    document.querySelectorAll('.needs-validation').forEach(form=>{
      form.addEventListener('submit', e=>{
        if(!form.checkValidity()){
          e.preventDefault();
          e.stopPropagation();
        }
        form.classList.add('was-validated');
      });
    });
  })();

  // autocomplete
  $('#model-input').autocomplete({
    source: "{% url 'model_dashboard:model_autocomplete' %}",
    minLength: 2
  });

  // dynamic metrics badges
  $(function(){
    const added = new Set();
    $('#add-metric-btn').click(()=>{
      const val = $('#metrics-input').val().trim();
      if(!val||added.has(val.toLowerCase())) return;
      added.add(val.toLowerCase());
      const $badge = $(`
        <div class="badge bg-secondary me-2 mb-2">
          ${val}
          <button type="button" class="btn-close btn-close-white btn-sm ms-1"></button>
          <input type="hidden" name="metrics[]" value="${val}">
        </div>`);
      $badge.find('.btn-close').click(()=>{
        $badge.remove();
        added.delete(val.toLowerCase());
      });
      $('#metrics-list').append($badge);
      $('#metrics-input').val('');
    });
  });
</script>
{% endblock %}
