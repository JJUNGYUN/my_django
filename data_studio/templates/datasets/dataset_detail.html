{% extends 'base.html' %}
{% block content %}
{% load markdown_extras %}
{% load custom_filters %}
{% load mathfilters %}

<head>
    <title>{{ dataset.name }}</title>
</head>
{% load static %}
<link rel="stylesheet" href="{% static 'prism/prism-tomorrow.css' %}">

<div class="container my-3">
    <section class="section-header">
        <div class="header-main">
            <h1 class="entity-title">{{ dataset.name }}</h1>
            <button class="copy-button" onclick="copyHiddenValue('copy-value')" aria-label="ê²½ë¡œ ë³µì‚¬">
                <img src="{% static 'svg/copy.svg' %}" alt="Copy" width="16" height="16">
            </button>
            <input type="hidden" id="copy-value" value="{{ dataset.dataset_path }}">
        </div>
        <div class="header-meta">
            <div class="badge-group">
                {% for tag in dataset.tag|split:"," %}
                <span class="badge-pill">{{ tag }}</span>
                {% endfor %}
            </div>
            <span class="meta-item">Author: {{ dataset.author.first_name }}({{dataset.author.last_name}})</span>
        </div>
    </section>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="readme-tab" data-bs-toggle="tab" href="#readme" role="tab"
                aria-controls="readme" aria-selected="true">
                README.md
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="file_system-tab" data-bs-toggle="tab" href="#file_system" role="tab"
                aria-controls="file_system" aria-selected="false">
                íŒŒì¼ ì‹œìŠ¤í…œ
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="data_studio-tab" data-bs-toggle="tab" href="#data_studio" role="tab"
                aria-controls="data_studio" aria-selected="false">
                ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°(50ê°œ)
            </a>
        </li>
    </ul>

    <div class="tab-content" style="overflow: hidden;">
        <!-- README -->
        <div class="tab-pane fade show active p-3 markdown position-relative"
            style="overflow-y: auto; max-height: 70vh;" id="readme" role="tabpanel" aria-labelledby="readme-tab">

            <div class="markdown-body" id="readme-view" style="padding-bottom: 60px;">
                {{ readme|mark|safe }}
            </div>

            <div id="readme-edit" style="display: none;">
                <form id="readme-form">
                    {% csrf_token %}
                    <textarea class="form-control" rows="20" name="readme_content" id="readme-content"
                        style="overflow-y: auto; resize: vertical; min-height: 400px;">{{ readme }}</textarea>
                    <div class="d-flex gap-2 mt-2">
                        <button type="submit" class="btn btn-sm btn-success">ì €ì¥</button>
                        <button type="button" class="btn btn-sm btn-secondary" id="cancel-edit">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- íŒŒì¼ ì‹œìŠ¤í…œ -->
        <div class="tab-pane fade p-3 overflow-auto" style="max-height: 70vh;" id="file_system" role="tabpanel"
            aria-labelledby="file_system-tab">
            <form method="post">
                {% csrf_token %}
                {% include "partials/file_system_viewr.html" %}
            </form>
        </div>

        <!-- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
        <div class="tab-pane fade p-3 overflow-auto" style="max-height: 70vh;" id="data_studio" role="tabpanel"
            aria-labelledby="data_studio-tab">
            {% include 'datasets/dataset_studio.html' %}
        </div>

        <!-- ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ -->
        <div class="d-flex justify-content-between align-items-center">
            {% if request.user == dataset.author %}
            <div class="position-sticky bottom-0 bg-white mt-2 pt-2" style="z-index: 10;">
                <button id="edit-readme-btn" class="btn btn-sm btn-outline-primary w-100">README ìˆ˜ì •</button>
            </div>
            {% endif %}
            <div class="my-3">
                {% if request.user == dataset.author %}
                <a href="{% url 'datasets:dataset_modify' dataset.id  %}" class="btn btn-sm btn-warning">ìˆ˜ì •</a>
                <a href="#" data-uri="{% url 'datasets:dataset_delete' dataset.id  %}"
                    class="delete btn btn-sm btn-danger">ì‚­ì œ</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'prism/prism.js' %}"></script>
<script src="{% static 'prism/components/prism-python.min.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // hash íƒ­ ë™ê¸°í™”
        const hash = window.location.hash;
        if (hash) {
            const tabTrigger = document.querySelector(`a[href="${hash}"]`);
            if (tabTrigger) {
                new bootstrap.Tab(tabTrigger).show();
            }
        }
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(link => {
            link.addEventListener('shown.bs.tab', function (event) {
                history.replaceState(null, null, event.target.getAttribute('href'));
            });
        });

        // ì‚­ì œ ë²„íŠ¼
        document.querySelectorAll(".delete").forEach(element => {
            element.addEventListener('click', function () {
                if (confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    location.href = this.dataset.uri;
                }
            });
        });

        function copyHiddenValue(id) {
            const val = document.getElementById(id).value;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(val)
                    .then(() => alert("ë³µì‚¬ ì™„ë£Œ!"))
                    .catch(err => {
                        console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
                        fallbackCopy(val);
                    });
            } else {
                fallbackCopy(val);  // ì§€ì› ì•ˆë  ë•Œ ëŒ€ì²´ ë°©ì‹
            }
        }

        function fallbackCopy(text) {
            const tempInput = document.createElement("textarea");
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand("copy");
                alert("ë³µì‚¬ ì™„ë£Œ! (fallback)");
            } catch (err) {
                alert("ë³µì‚¬ ì‹¤íŒ¨ ğŸ˜¢");
            }
            document.body.removeChild(tempInput);
        }

        window.copyHiddenValue = copyHiddenValue;

        // README ìˆ˜ì • í† ê¸€
        const editBtn = document.getElementById("edit-readme-btn");
        const readmeDisplay = document.getElementById("readme-display");
        const readmeEdit = document.getElementById("readme-edit");
        const cancelBtn = document.getElementById("cancel-edit");

        if (editBtn) {
            editBtn.addEventListener("click", function () {
                readmeDisplay.style.display = "none";
                readmeEdit.style.display = "block";
            });
        }

        cancelBtn.addEventListener("click", function () {
            readmeEdit.style.display = "none";
            readmeDisplay.style.display = "block";
        });

        // README ì €ì¥ Ajax
        const readmeForm = document.getElementById("readme-form");
        readmeForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const content = document.getElementById("readme-content").value;
            fetch("{% url 'datasets:readme_update' dataset.id %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: new URLSearchParams({
                    'readme_content': content
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        readmeDisplay.innerHTML = data.updated_html + '<button id="edit-readme-btn" class="btn btn-sm btn-outline-primary mt-2">README ìˆ˜ì •</button>';
                        readmeEdit.style.display = "none";
                        readmeDisplay.style.display = "block";
                        location.reload();  // ë²„íŠ¼ ë‹¤ì‹œ ë°”ì¸ë”©ì„ ìœ„í•´ ë¦¬ë¡œë“œ ë˜ëŠ” ë™ì  ë°”ì¸ë”© í•„ìš”
                    } else {
                        alert("ì €ì¥ ì‹¤íŒ¨!");
                    }
                });
        });
    });
</script>
{% endblock %}