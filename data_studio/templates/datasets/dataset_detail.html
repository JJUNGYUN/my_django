{% extends 'base.html' %}
{% block content %}
{% load markdown_extras %}
{% load custom_filters %}
{% load mathfilters %}

<head>
    <title>{{ dataset.name }}</title>
</head>
{% load static %}
<link rel="stylesheet" href="{% static 'prism/prism-tomorrow.css' %}">

<div class="container my-3">
    <section class="section-header">
        <div class="header-main">
            <h1 class="entity-title">{{ dataset.name }}</h1>
            <button class="copy-button" onclick="copyHiddenValue('copy-value')" aria-label="경로 복사">
                <img src="{% static 'svg/copy.svg' %}" alt="Copy" width="16" height="16">
            </button>
            <input type="hidden" id="copy-value" value="{{ model.weight_path }}">
        </div>
        <div class="header-meta">
            <div class="badge-group">
                {% for tag in dataset.tag|split:"," %}
                <span class="badge-pill">{{ tag }}</span>
                {% endfor %}
            </div>
            <span class="meta-item">Author: {{ dataset.author }}</span>
        </div>
    </section>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="readme-tab" data-bs-toggle="tab" href="#readme" role="tab"
                aria-controls="readme" aria-selected="true">
                README.md
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="file_system-tab" data-bs-toggle="tab" href="#file_system" role="tab"
                aria-controls="file_system" aria-selected="false">
                파일 시스템
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="data_studio-tab" data-bs-toggle="tab" href="#data_studio" role="tab"
                aria-controls="data_studio" aria-selected="false">
                데이터 미리보기(50개)
            </a>
        </li>
    </ul>

    <div class="tab-content" style="overflow: hidden;">
        <!-- README -->
        <div class="tab-pane fade show active p-3 markdown position-relative" style="overflow-y: auto; max-height: 70vh;" 
        id="readme" role="tabpanel" aria-labelledby="readme-tab">
    
        <div class="markdown-body" id="readme-view" style="padding-bottom: 60px;">
            {{ readme|mark|safe }}
        </div>
    
        <div id="readme-edit" style="display: none;">
            <form id="readme-form">
                {% csrf_token %}
                <textarea class="form-control" rows="20" name="readme_content" id="readme-content"
                    style="overflow-y: auto; resize: vertical; min-height: 400px;">{{ readme }}</textarea>
                <div class="d-flex gap-2 mt-2">
                    <button type="submit" class="btn btn-sm btn-success">저장</button>
                    <button type="button" class="btn btn-sm btn-secondary" id="cancel-edit">취소</button>
                </div>
            </form>
        </div>    
    </div>
        <!-- 파일 시스템 -->
        <div class="tab-pane fade p-3 overflow-auto" style="max-height: 70vh;" id="file_system" role="tabpanel"
            aria-labelledby="file_system-tab">
            <form method="post">
                {% csrf_token %}
                {% include "partials/file_system_viewr.html" %}
            </form>
        </div>

        <!-- 데이터 미리보기 -->
        <div class="tab-pane fade p-3 overflow-auto" style="max-height: 70vh;" id="data_studio" role="tabpanel"
            aria-labelledby="data_studio-tab">
            {% include 'datasets/dataset_studio.html' %}
        </div>

        <!-- 수정 / 삭제 버튼 -->
        <div class="d-flex justify-content-between align-items-center">
            {% if request.user == dataset.author %}
            <div class="position-sticky bottom-0 bg-white mt-2 pt-2" style="z-index: 10;">
                <button id="edit-readme-btn" class="btn btn-sm btn-outline-primary w-100">README 수정</button>
            </div>
            {% endif %}
            <div class="my-3">
                {% if request.user == dataset.author %}
                <a href="{% url 'datasets:dataset_modify' dataset.id  %}" class="btn btn-sm btn-warning">수정</a>
                <a href="#" data-uri="{% url 'datasets:dataset_delete' dataset.id  %}"
                    class="delete btn btn-sm btn-danger">삭제</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'prism/prism.js' %}"></script>
  <script src="{% static 'prism/components/prism-python.min.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // hash 탭 동기화
        const hash = window.location.hash;
        if (hash) {
            const tabTrigger = document.querySelector(`a[href="${hash}"]`);
            if (tabTrigger) {
                new bootstrap.Tab(tabTrigger).show();
            }
        }
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(link => {
            link.addEventListener('shown.bs.tab', function (event) {
                history.replaceState(null, null, event.target.getAttribute('href'));
            });
        });

        // 삭제 버튼
        document.querySelectorAll(".delete").forEach(element => {
            element.addEventListener('click', function () {
                if (confirm("정말로 삭제하시겠습니까?")) {
                    location.href = this.dataset.uri;
                }
            });
        });

        // 복사 버튼
        window.copyHiddenValue = function (id) {
            const val = document.getElementById(id).value;
            navigator.clipboard.writeText(val)
                .then(() => alert("복사 완료!"));
        };

        // README 수정 토글
        const editBtn = document.getElementById("edit-readme-btn");
        const readmeDisplay = document.getElementById("readme-display");
        const readmeEdit = document.getElementById("readme-edit");
        const cancelBtn = document.getElementById("cancel-edit");

        if (editBtn) {
            editBtn.addEventListener("click", function () {
                readmeDisplay.style.display = "none";
                readmeEdit.style.display = "block";
            });
        }

        cancelBtn.addEventListener("click", function () {
            readmeEdit.style.display = "none";
            readmeDisplay.style.display = "block";
        });

        // README 저장 Ajax
        const readmeForm = document.getElementById("readme-form");
        readmeForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const content = document.getElementById("readme-content").value;
            fetch("{% url 'datasets:readme_update' dataset.id %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: new URLSearchParams({
                    'readme_content': content
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        readmeDisplay.innerHTML = data.updated_html + '<button id="edit-readme-btn" class="btn btn-sm btn-outline-primary mt-2">README 수정</button>';
                        readmeEdit.style.display = "none";
                        readmeDisplay.style.display = "block";
                        location.reload();  // 버튼 다시 바인딩을 위해 리로드 또는 동적 바인딩 필요
                    } else {
                        alert("저장 실패!");
                    }
                });
        });
    });
</script>
{% endblock %}