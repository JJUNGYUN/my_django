{% extends 'base.html' %}

{% load markdown_extras %}
{% load custom_filters %}
{% load mathfilters %}
{% block content %}
{% if messages %}
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    {% for message in messages %}
    <div class="toast align-items-center text-bg-{{ message.tags }} border-0 show" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="container py-4">

    <form method="post" action="{% url 'label_studio:modify_project' project.id %}">
        {% csrf_token %}


        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">{{ project.title }} (관리자)</h2>
    
            <div>
                <button type="submit" class="btn btn-success btn-hit">저장</button>
    
                <!-- 삭제 버튼: 별도 폼을 사용 -->
                <form method="post" action="{% url 'label_studio:delete_project' project.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('정말 이 프로젝트를 삭제하시겠습니까? 삭제된 데이터는 복구할 수 없습니다.');">
                        삭제
                    </button>
                </form>
            </div>
        </div>

        <!-- 프로젝트 설정 카드 -->
        <div class="accordion mb-4" id="projectAccordion">
            <div class="accordion-item shadow-sm">
                <h2 class="accordion-header" id="headingProjectSettings">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseProjectSettings" aria-expanded="false"
                        aria-controls="collapseProjectSettings">
                        프로젝트 설정
                    </button>
                </h2>
                <div id="collapseProjectSettings" class="accordion-collapse collapse"
                    aria-labelledby="headingProjectSettings" data-bs-parent="#projectAccordion">
                    <div class="accordion-body">

                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <textarea class="form-control" name="description"
                                rows="3">{{ project.description }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">시작일</label>
                                <input type="date" class="form-control" name="start_date"
                                    value="{{ project.start_date|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">마감일</label>
                                <input type="date" class="form-control" name="end_date"
                                    value="{{ project.end_date|date:'Y-m-d' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">상태</label>
                                <select class="form-select" name="task_status">
                                    <option value="in_progress" {% if project.task_status == "in_progress" %} selected {% endif %}>작업중</option>
                                    <option value="completed" {% if project.task_status == "completed" %} selected {% endif %}>완료</option>
                                    <option value="stopped" {% if project.task_status == "stopped" %} selected {% endif %}>
                                        중단</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </form>
    <!-- 탭 영역 -->
    <!-- 탭 네비게이션 -->
    <ul class="nav nav-tabs" id="projectTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active px-4 py-2" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress"
                type="button" role="tab">진행 현황</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 py-2" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button"
                role="tab">작업 데이터</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 py-2" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload"
                type="button" role="tab">데이터 업로드</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 py-2" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button"
                role="tab">업로드 데이터</button>
        </li>
        {% if project.task_type == "classification" or project.task_type == "evaluation" %}
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 py-2" id="label-tab" data-bs-toggle="tab" data-bs-target="#label" type="button"
                role="tab">레이블 관리</button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 py-2" id="work-tab" data-bs-toggle="tab" data-bs-target="#work" type="button"
                role="tab">내 작업</button>
        </li>
    </ul>
    <!-- 탭 콘텐츠 영역 -->
    <div class="tab-content" id="projectTabContent">

        <!-- 진행 현황 -->
        <!-- 기존 작업자 진행 현황 카드 내에 버튼 추가 -->
        <div class="tab-pane fade show active border-0" id="progress" role="tabpanel">
            <div class="label-card shadow-sm p-4 mb-4 rounded-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold">작업자 진행 현황</h5>
                    <button class="btn hit-btn-outline-primary btn-sm" data-bs-toggle="modal"
                        data-bs-target="#addWorkerModal">
                        + 작업자 추가
                    </button>
                </div>

                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        {% for a in assignments %}
                        <tr>
                            <td>{{ a.worker.first_name }}({{a.worker.last_name}})</td>
                            <td>{{ a.progress }}%</td>
                            <td>
                                {% if a.status == "in_progress" %}
                                <span class="badge bg-warning text-white">진행중</span>
                                {% elif a.status == "completed" %}
                                <span class="badge bg-success text-white">완료</span>
                                {% else %}
                                <span class="badge bg-secondary text-white">{{ a.get_status_display }}</span>
                                {% endif %}
                            </td>
                            <td>{{ a.last_updated|date:"Y-m-d" }}</td>
                        </tr>
                        {% endfor %}

                        </tbody>
                </table>
            </div>
        </div>

        <!-- 작업자 추가 모달 -->
        <div class="modal fade" id="addWorkerModal" tabindex="-1" aria-labelledby="addWorkerModalLabel"
            aria-hidden="true">

            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addWorkerModalLabel">작업자 선택</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="worker-form" action="{% url 'label_studio:sync_workers' project.id %}">
                            {% csrf_token %}
                            <p class="mb-2">작업자로 등록할 사용자를 체크하세요:</p>

                            {% for user in users %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="workers" value="{{ user.id }}"
                                    id="user{{ user.id }}" {% if user in assigned_users %}checked{% endif %}>
                                <label class="form-check-label" for="user{{ user.id }}">
                                    {{ user.first_name }}({{ user.last_name }})
                                </label>
                            </div>
                            {% endfor %}

                            <div class="modal-footer">
                                <button type="button" class="btn hit-btn-outline-red" data-bs-dismiss="modal">취소</button>
                                <button type="button" class="btn hit-btn-outline-primary" onclick="confirmAndSubmit()">저장</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- 작업 데이터 -->
        <div class="tab-pane fade border-0" id="data" role="tabpanel">
            <div class="label-card shadow-sm p-4 mb-4 rounded-3">

                <!-- 상단: 제목 + 다운로드 -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold">작업 결과</h5>
                    <div>
                        <a href="{% url 'label_studio:download_all' project.id %}" class="btn hit-btn-outline-dark me-2">
                            전체 다운로드
                        </a>
                        <div class="btn-group">
                            <button type="button" class="btn hit-btn-outline-primary dropdown-toggle"
                                data-bs-toggle="dropdown">
                                작업자별 다운로드
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% for user in project.workers.all %}
                                <li>
                                    <a class="dropdown-item"
                                        href="{% url 'label_studio:download_user' project.id user.id %}">
                                        {{ user.first_name }}({{ user.last_name }}) 다운로드
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- 필터 UI -->
                <form method="get" class="d-flex gap-2 mb-3 align-items-center">
                    <select name="worker" class="form-select w-auto">
                        <option value="">전체 작업자</option>
                        {% for user in project.workers.all %}
                        <option value="{{ user.id }}" {% if selected_worker == user.id %}selected{% endif %}>
                            {{ user.first_name }}({{ user.last_name }})
                        </option>
                        {% endfor %}
                    </select>

                    <select name="input" class="form-select w-auto">
                        <option value="">전체 데이터</option>
                        {% for item in input_data %}
                        <option value="{{ item.id }}" {% if selected_input == item.id %}selected{% endif %}>
                            #{{ item.order }}
                        </option>
                        {% endfor %}
                    </select>

                    <button type="submit" class="btn hit-btn-outline-primary">필터 적용</button>
                </form>
                <table class="manager-table">
                    <thead>
                        <tr>
                          <th style="width:60px">ID</th>
                          <th style="width:100px">작업자</th>
                          <th style="min-width:300px">내용</th>
                          <th style="width:150px">레이블/요약</th>
                          <th style="width:120px">제출일</th>
                        </tr>
                      </thead>
                    <tbody>
                        {% for result in all_user_work_results %}
                        <!-- 기본 행 -->
                        <tr class="expand-trigger" style="cursor:pointer">
                            <td>#{{ result.input_data.order }}</td>
                            <td>{{ result.worker.first_name }}({{ result.worker.last_name }})</td>
                            <td class="text-truncate" title="{{ result.input_data.data.input }}">
                                {% if project.task_type == "evaluation" %}
                                    <span class="badge bg-info text-dark">input</span>
                                    {{ result.input_data.data.input|truncatechars:50 }}
                                    <br>
                                    <span class="badge bg-info text-dark">output</span>
                                    {{ result.input_data.data.output|truncatechars:50 }}
                                {% elif project.task_type == "compare" %}
                                    <span class="badge bg-info-subtle text-dark">input</span>
                                    {{ result.input_data.data.input|truncatechars:50 }}<br>
                                    <span class="badge bg-primary-subtle text-dark">output A</span>
                                    {{ result.input_data.data.output_a|truncatechars:50 }}<br>
                                    <span class="badge bg-success-subtle text-dark">output B</span>
                                    {{ result.input_data.data.output_b|truncatechars:50 }}
                                {% elif project.task_type == "hierarchy" %}
                                    {{ result.input_data.data.input|truncatechars:50 }}
                                {% else %}
                                    {{ result.input_data.data.input|truncatechars:50 }}
                                {% endif %}
                            </td>
                            <td>
                                {% if project.task_type == "classification" or project.task_type == "compare" %}
                                {{ result.result.label }}
                                {% elif project.task_type == "evaluation" %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for key, val in result.result.items %}
                                      <span class="badge bg-primary-subtle text-dark">
                                        {{ key }}: <strong>{{ val }}</strong>
                                      </span>
                                    {% endfor %}
                                </div>
                                {% elif project.task_type == "hierarchy" %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for val in result.result.label %}
                                      <span class="badge bg-primary-subtle text-dark">
                                        <strong>{{ val }}</strong>
                                      </span>
                                    {% endfor %}
                                </div>
                                {% elif project.task_type == "summary" %}
                                <span class="text-muted small">{{ result.result.summary }}</span>
                                {% endif %}
                            </td>
                            <td>{{ result.created_at|date:"Y-m-d" }}</td>
                        </tr>
                    
                        <!-- 확장 행 -->
                        <tr class="expand-content d-none">
                            <td colspan="5">
                                    {% if project.task_type == "evaluation" %}
                                    <p><strong>Input:</strong><br>{{ result.input_data.data.input|linebreaksbr }}</p>
                                    <p><strong>Output:</strong><br>{{ result.input_data.data.output|linebreaksbr }}</p>
                                    {% elif project.task_type == "compare" %}
                                    <p><strong>Input:</strong><br>{{ result.input_data.data.input|linebreaksbr }}</p>
                                    <p><strong>Output A:</strong><br>{{ result.input_data.data.output_a|linebreaksbr }}</p>
                                    <p><strong>Output B:</strong><br>{{ result.input_data.data.output_b|linebreaksbr }}</p>
                                    {% elif project.task_type == "summary" %}
                                    <p><strong>Text:</strong><br>{{ result.input_data.data.input|linebreaksbr }}</p>
                                    {% else %}
                                    <p><strong>Text:</strong><br>{{ result.input_data.data.input|linebreaksbr}}</p>
                                    {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">작업 결과가 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- 페이지네이션 -->
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if all_user_work_results.has_previous %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ all_user_work_results.previous_page_number }}{% if selected_worker %}&worker={{ selected_worker }}{% endif %}{% if selected_input %}&input={{ selected_input }}{% endif %}">이전</a>
                        </li>
                        {% endif %}

                        <li class="page-item disabled">
                            <span class="page-link">페이지 {{ all_user_work_results.number }} / {{ all_user_work_results.paginator.num_pages }}</span>
                        </li>

                        {% if all_user_work_results.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ all_user_work_results.next_page_number }}{% if selected_worker %}&worker={{ selected_worker }}{% endif %}{% if selected_input %}&input={{ selected_input }}{% endif %}">다음</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>

            </div>
        </div>

        <!-- 파일 업로드 -->
        <div class="tab-pane fade border-0" id="upload" role="tabpanel">
            <div class="label-card shadow-sm p-4 mb-4 rounded-3">
                <h5 class="fw-bold mb-3">데이터 업로드</h5>
                <form method="post" enctype="multipart/form-data"
                    action="{% url 'label_studio:upload_input_data' project.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="uploadFile" class="form-label">JSONL 파일 선택</label>
                        <input class="form-control" type="file" name="uploadFile" id="uploadFile" accept=".jsonl">
                    </div>
                    <button type="submit" class="btn hit-btn-outline-dark">업로드</button>
                </form>

            </div>
        </div>
        <!-- 업로드된 원본 데이터 탭 -->
        <div class="tab-pane fade border-0" id="input" role="tabpanel">
            <div class="label-card shadow-sm p-4 mb-4 rounded-3">
                <h5 class="fw-bold mb-3">업로드된 Input 데이터</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>순번</th>
                            <th>데이터</th>
                            <th>업로드일</th>
                            <th>활성 여부</th>
                            <th>삭제</th> <!-- 추가 -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for input in input_data %}
                        <tr>
                            <td>{{ input.order }}</td>
                            <td>{{ input.data }}</td>
                            <td>{{ input.created_at|date:"Y-m-d" }}</td>
                            <td>
                                {% if input.is_active %}
                                <span class="badge bg-success text-white">활성</span>
                                {% else %}
                                <span class="badge bg-secondary text-white">비활성</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="{% url 'label_studio:delete_input' project.id input.id %}"
                                    style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm hit-btn-outline-red"
                                        onclick="return confirm('이 입력 데이터를 삭제하시겠습니까?');">삭제</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
            <nav class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if input_data.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?input_page={{ input_data.previous_page_number }}">이전</a>
                    </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link">페이지 {{ input_data.number }} / {{ input_data.paginator.num_pages }}</span>
                    </li>

                    {% if input_data.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?input_page={{ input_data.next_page_number }}">다음</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>

        </div>
        {% if project.task_type == "classification" or project.task_type == "evaluation" %}
        <!-- 라벨 관리 탭 -->
        <div class="tab-pane fade border-0" id="label" role="tabpanel">
            <div class="label-card shadow-sm p-4 mb-4 rounded-3">
                <h5 class="fw-bold mb-3">프로젝트 레이블 관리</h5>

                <!-- 레이블 테이블 -->
                <table class="table table-bordered table-striped mb-4">
                    <thead class="table-light">
                        <tr>
                            <th>이름</th>
                            <th>타입</th>
                            <th>설명</th>
                            <th>표시 순서</th>
                            <th>수정</th>
                            <th>삭제</th> <!-- 추가 -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for label in labels %}
                        <tr>
                            <td>{{ label.name }}</td>
                            <td>{{ label.label_type }}</td>
                            <td>{{ label.description }}</td>
                            <td>{{ label.order }}</td>
                            <td><button class="btn btn-sm hit-btn-outline-primary">수정</button></td>
                            <td>
                                <form method="post" action="{% url 'label_studio:delete_label' project.id label.id %}"
                                    style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('이 레이블을 삭제하시겠습니까?');">삭제</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>


                <!-- 신규 라벨 추가 -->
                <h6 class="fw-bold mb-3">새 레이블 추가</h6>
                <form method="post" action="{% url 'label_studio:add_label' project.id %}" class="row g-3">
                    {% csrf_token %}
                    <div class="col-md-4">
                        <label for="labelName" class="form-label">레이블명</label>
                        <input type="text" class="form-control" id="labelName" name="name" placeholder="예: 중립">
                    </div>
                    <div class="col-md-3">
                        <label for="labelType" class="form-label">타입</label>
                        <select class="form-select" id="labelType" name="label_type">
                            <option selected>{{project.task_type}}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="labelOrder" class="form-label">표시 순서</label>
                        <input type="number" class="form-control" id="labelOrder" name="order" value="0">
                    </div>
                    <div class="col-md-12">
                        <label for="labelDesc" class="form-label">설명</label>
                        <textarea class="form-control" id="labelDesc" name="description" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn hit-btn-solid-dark">레이블 추가</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        <div class="tab-pane fade border-0" id="work" role="tabpanel">
            <div class="label-card shadow-sm p-4 mb-4 rounded-3">
                <!-- 3) 작업 결과 & 남은 데이터 테이블 -->
    <div class="mb-4">

        <!-- 작업 결과 아코디언 (기본 접힘) -->
        <div class="accordion mb-2" id="resultAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingResults">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseResults" aria-expanded="false" aria-controls="collapseResults">
                        작업 결과
                    </button>
                </h2>
                <div id="collapseResults" class="accordion-collapse collapse" aria-labelledby="headingResults"
                    data-bs-parent="#resultAccordion">
                    <div class="accordion-body p-0">
                        <div style="max-height:300px; overflow-y:auto;">
                            <table class="manager-table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>작업자</th>
                                        <th style="min-width:300px">내용</th>
                                        <th>레이블/요약</th>
                                        <th>제출일</th>
                                        <th>작업하기</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in work_results %}
                                    
                                    <tr class="expand-trigger" style="cursor:pointer;">
                                        <td>#{{ result.input_data.order }}</td>
                                        <td>{{ result.worker.username }}</td>
                                        <td class="text-truncate" style="max-width:300px;"
                                            title="{{ result.input_data.data.input }}">
                                            {% if project.task_type == "evaluation" %}
                                                <span class="badge bg-info text-dark">in</span>
                                                {{ result.input_data.data.input|truncatechars:50 }}<br>
                                                <span class="badge bg-info text-dark">out</span>
                                                {{ result.input_data.data.output|truncatechars:50 }}
                                            {% elif project.task_type == "compare" %}
                                                <span class="badge bg-info text-dark">in</span>
                                                {{ result.input_data.data.input|truncatechars:50 }}<br>
                                                <span class="badge bg-primary text-dark">A</span>
                                                {{ result.input_data.data.output_a|truncatechars:50 }}<br>
                                                <span class="badge bg-success text-dark">B</span>
                                                {{ result.input_data.data.output_b|truncatechars:50 }}
                                            {% else %}
                                                {{ result.input_data.data.input|truncatechars:50 }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if project.task_type in "classification,compare" %}
                                            {{ result.result.label }}
                                            {% elif project.task_type == "evaluation" %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for key,val in result.result.items %}
                                                <span class="badge bg-primary-subtle text-dark">
                                                    {{ key }}: <strong>{{ val }}</strong>
                                                </span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <span class="text-muted small">{{ result.result.summary }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ result.created_at|date:"Y-m-d" }}</td>
                                        <td>
                                            <a href="{% url 'label_studio:work_entry' project.id %}?data_order={{ result.input_data.order }}"
                                                class="label-btn label-btn-primary btn-sm">
                                                작업하기
                                            </a>
                                        </td>
                                    </tr>
                                    <tr class="expand-content d-none">
                                        <td colspan="6" class="bg-light p-3">
                                            {% if project.task_type == "evaluation" %}
                                            <p><strong>Input:</strong><br>{{ result.input_data.data.input|linebreaksbr
                                                }}</p>
                                            <p><strong>Output:</strong><br>{{ result.input_data.data.output|linebreaksbr
                                                }}</p>
                                            {% elif project.task_type == "compare" %}
                                            <p><strong>Input:</strong><br>{{ result.input_data.data.input|linebreaksbr
                                                }}</p>
                                            <p><strong>A:</strong><br>{{ result.input_data.data.output_a|linebreaksbr }}
                                            </p>
                                            <p><strong>B:</strong><br>{{ result.input_data.data.output_b|linebreaksbr }}
                                            </p>
                                            {% else %}
                                            <p><strong>Text:</strong><br>{{ result.input_data.data.input|linebreaksbr }}
                                            </p>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">작업 결과가 없습니다.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 3) 남은 작업 데이터 -->
        <div class="accordion" id="remainingAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingRemaining">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseRemaining" aria-expanded="true" aria-controls="collapseRemaining">
                        남은 데이터 (아직 작업하지 않음)
                    </button>
                </h2>
                <div id="collapseRemaining" class="accordion-collapse collapse show" aria-labelledby="headingRemaining"
                    data-bs-parent="#remainingAccordion">
                    <div class="accordion-body p-0">
                        <div style="max-height:300px; overflow-y:auto;">
                            <table class="manager-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>내용</th>
                                        <th>작업 시작</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inp in remaining_inputs %}
                                    <tr>
                                        <td>#{{ inp.order }}</td>
                                        {% with inp=inp.data|dict_get:"input" %}
                                        <td class="text-truncate"
                                            title="{{ inp }}">
                                            {{ txt|default:inp|truncatechars:50 }}
                                        </td>
                                        {% endwith %}
                                        <td>
                                            <a href="{% url 'label_studio:work_entry' project.id %}?data_order={{ inp.order }}"
                                                class="hit-btn-outline-primary btn-sm">
                                                시작
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center">남은 데이터가 없습니다.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toastElList = [].slice.call(document.querySelectorAll('.toast'))
        toastElList.forEach(function (toastEl) {
            new bootstrap.Toast(toastEl).show()
        });
    });
</script>

<script>
    function confirmAndSubmit() {
        const confirmed = confirm("선택한 작업자 설정으로 저장하시겠습니까?\n기존 작업자 중 체크 해제된 사용자 및 사용자의 작업결과는 제거됩니다.");
        if (confirmed) {
            document.getElementById('worker-form').submit();
        }
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 저장된 탭 ID가 있으면 해당 탭 활성화
        const savedTabId = localStorage.getItem("activeTab");
        if (savedTabId) {
            const tabTrigger = document.querySelector(`button[data-bs-target='${savedTabId}']`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }

        // 탭 변경 시 localStorage에 저장
        const tabButtons = document.querySelectorAll('#projectTab button[data-bs-toggle="tab"]');
        tabButtons.forEach(function (btn) {
            btn.addEventListener("shown.bs.tab", function (e) {
                const activeTabId = e.target.getAttribute("data-bs-target");
                localStorage.setItem("activeTab", activeTabId);
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".expand-trigger").forEach(row => {
        row.addEventListener("click", () => {
          const next = row.nextElementSibling;
          if (next && next.classList.contains("expand-content")) {
            next.classList.toggle("d-none");
          }
        });
      });
    });
    </script>
    

{% endblock %}