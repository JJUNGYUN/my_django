{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <!-- ì§„í–‰ë„ + í˜„ì¬ ìœ„ì¹˜ í†µí•© í‘œì‹œ -->
    <div class="card bg-light border-0 shadow-sm mb-4">
        <div class="card-body py-3 px-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h5 class="mb-0 fw-bold text-primary">{{ project.title }} ì‘ì—… ì§„í–‰</h5>
                    <small class="text-muted">í˜„ì¬ ìœ„ì¹˜: <strong>{{ current_index }}</strong> / {{ total_inputs }}</small>
                </div>
                <div class="text-end">
                    <span class="text-muted me-2">ì§„í–‰ë„:</span>
                    <strong>{{ progress }}%</strong>
                </div>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                    <span class="fw-bold">{{ progress }}%</span>
                </div>
            </div>
        </div>
    </div>


    <!-- ì‘ì—… ì¹´ë“œ -->
    <form id="labelForm" method="post" action="{% url 'label_studio:submit_work' project.id %}"
        class="label-form">
        {% csrf_token %}
        <div class="label-card">
            <div class="label-card-header">
                <h5>{{ project.title }} ì‘ì—… {{ current_index }} / {{ total_inputs }}</h5>
            </div>
            <div class="label-card-body">
                <p class="label-text">{{ input_data.data.text }}</p>
                <input type="hidden" name="input_id" value="{{ input_data.id }}">
                <input type="hidden" name="data_order" id="data_order">
    
                <div class="label-group mb-4">
                    <label class="label-group-title">ë ˆì´ë¸” ì„ íƒ</label>
                    <div class="label-radio-group">
                    {% for label in labels %}
                    <input type="radio" class="label-radio-input" name="label"
                            id="label{{ forloop.counter }}" value="{{ label.name }}"
                            {% if selected_label == label.name %}checked{% endif %}>
                    <label for="label{{ forloop.counter }}" class="label-radio-label">
                        {{ label.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
    
<!-- ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
<div class="d-flex justify-content-between align-items-center mt-4 gap-2">
    {% if current_index > 1 %}
      <!-- ì´ì „: order-1 -->
      <button type="button"
              class="btn hit-btn-outline-primary"
              onclick="submitAndGo({{ input_data.order|add:-1 }})">
        â† ì´ì „
  </button>
   {% endif %}

 <div class="d-flex gap-2">
     <button type="button"
             class="btn btn-outline-success btn-sm guideline-toggle-btn"
             onclick="toggleGuideline()">
         ğŸ“˜ ê°€ì´ë“œë¼ì¸ & ğŸ’¬ ì½”ë©˜íŠ¸ ì‘ì„±
     </button>
     {% include "label_studio/guide_line.html" %}

        {% if is_last_input %}
          <!-- ì™„ë£Œ: í˜„ì¬ order -->
          <button type="button"
                  class="btn hit-btn-solid-primary"
                  onclick="submitAndGo({{ input_data.order }})">
            í‰ê°€ ì €ì¥ ì™„ë£Œ
          </button>
        {% else %}
          <!-- ë‹¤ìŒ: order+1 -->
          <button type="button"
                  class="btn hit-btn-outline-primary"
                  onclick="submitAndGo({{ input_data.order|add:1 }})">
            ì €ì¥í•˜ê³  ë‹¤ìŒ â†’
          </button>
        {% endif %}
 </div>
</div>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById('labelForm');
      if (!form) return;
    
      let currentOrder = {{ input_data.order }};
      window.submitAndGo = function(targetOrder) {
        // ì´ì „(ìˆœì„œê°€ ì‘ìœ¼ë©´) : ì„ íƒ ì—†ì´ ë°”ë¡œ ì´ë™
    
        // ë‹¤ìŒ/ì™„ë£Œ : ë°˜ë“œì‹œ ì„ íƒ
        const selected = form.querySelector('input[name="label"]:checked');
        if (!selected) {
          alert("âš ï¸ ë ˆì´ë¸”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        if (targetOrder < currentOrder) {
          document.getElementById('data_order').value = targetOrder;
          return form.submit();
        }
    
        if (!confirm("ì„ íƒí•œ ë ˆì´ë¸”ì„ ì €ì¥í•˜ê³  ë‹¤ìŒ ì‘ì—…ìœ¼ë¡œ ì´ë™í• ê¹Œìš”?")) return;
    
        document.getElementById('data_order').value = targetOrder;
        form.submit();
      };
    
      // í¼ ì œì¶œ ì „ì—ë„ ë™ì¼í•œ ê²€ì¦
      form.addEventListener('submit', e => {
        const selected = form.querySelector('input[name="label"]:checked');
        if (!selected) {
          e.preventDefault();
          alert("âš ï¸ ë ˆì´ë¸”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
      });
    });
    </script>
    
{% endblock %}