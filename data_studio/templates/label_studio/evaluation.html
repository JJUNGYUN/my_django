{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container py-4">
    <!-- ì§„í–‰ë„ ì¹´ë“œ -->
    <div class="label-card mb-4">
        <div class="label-card-body d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1 text-primary">{{ project.title }} í‰ê°€ ì‘ì—…</h5>
                <small class="text-muted">í˜„ì¬ ìœ„ì¹˜: <strong>{{ current_index }}</strong> / {{ total_inputs }}</small>
            </div>
            <div style="width: 35%;">
                <div class="d-flex align-items-center mb-1">
                    <span class="me-2 text-muted">ì§„í–‰ë„:</span>
                    <strong>{{ progress }}%</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: {{ progress }}%;"
                         aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- í‰ê°€ í¼ ì‹œì‘ -->
    <form id="evaluationForm"
          method="post"
          action="{% url 'label_studio:submit_work' project.id %}">
        {% csrf_token %}
        <input type="hidden" name="input_id" value="{{ input_data.id }}">
        <input type="hidden" name="data_order" id="data_order">

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="label-card shadow-sm">

                    <!-- ì¹´ë“œ í—¤ë” -->
                    <div class="label-card-header text-white">
                        <h5 class="mb-0">ì‘ì—… {{ current_index }} / {{ total_inputs }}</h5>
                    </div>

                    <!-- ì¹´ë“œ ë°”ë”” -->
                    <div class="label-card-body">

                        <!-- ì…ë ¥/ì¶œë ¥ ì•„ì½”ë””ì–¸ -->
                        <div class="accordion mb-4" id="ioAccordion">
                            <!-- Input -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="hInput">
                                    <button class="accordion-button" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#cInput"
                                            aria-expanded="true"
                                            aria-controls="cInput">
                                        ì…ë ¥ (Input)
                                    </button>
                                </h2>
                                <div id="cInput"
                                     class="accordion-collapse collapse show"
                                     aria-labelledby="hInput">
                                    <div class="accordion-body text-box-scroll">
                                        {{ input_data.data.input }}
                                    </div>
                                </div>
                            </div>
                            <!-- Output -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="hOutput">
                                    <button class="accordion-button text-primary" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#cOutput"
                                            aria-expanded="true"
                                            aria-controls="cOutput">
                                        ì¶œë ¥ (Output)
                                    </button>
                                </h2>
                                <div id="cOutput"
                                     class="accordion-collapse collapse show"
                                     aria-labelledby="hOutput">
                                    <div class="accordion-body">
                                        <p class="mb-0">{{ input_data.data.output }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /ì…ë ¥/ì¶œë ¥ ì•„ì½”ë””ì–¸ -->

                        <!-- ìŠ¤ì½”ì–´ ì„ íƒ -->
                        {% for label in labels %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ label.name }}</label>
                            <div class="btn-group" role="group" aria-label="{{ label.name }}">
                                {% with selected_scores|get_item:label.name as current_score %}
                                    {% for opt in label.description|split:"," %}
                                        {% with opt|trim as v %}
                                            <input type="radio"
                                                   class="label-radio-input"
                                                   name="score_{{ label.name }}"
                                                   id="score_{{ label.name }}_{{ forloop.counter }}"
                                                   value="{{ v }}"
                                                   {% if current_score == v %}checked{% endif %}
                                                   autocomplete="off">
                                            <label class="label-radio-label"
                                                   for="score_{{ label.name }}_{{ forloop.counter }}">
                                                {{ v }}
                                            </label>
                                        {% endwith %}
                                    {% endfor %}
                                {% endwith %}
                            </div>
                        </div>
                        {% endfor %}

                        <!-- ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
                        <div class="d-flex justify-content-between align-items-center mt-4 gap-2">
                               {% if current_index > 1 %}
                                 <!-- ì´ì „: order-1 -->
                                 <button type="button"
                                         class="btn hit-btn-outline-primary"
                                         onclick="submitAndGo({{ input_data.order|add:-1 }})">
                                   â† ì´ì „
                             </button>
                              {% endif %}

                            <div class="d-flex gap-2">
                                <button type="button"
                                        class="btn btn-outline-success btn-sm guideline-toggle-btn"
                                        onclick="toggleGuideline()">
                                    ğŸ“˜ ê°€ì´ë“œë¼ì¸ & ğŸ’¬ ì½”ë©˜íŠ¸ ì‘ì„±
                                </button>
                                {% include "label_studio/guide_line.html" %}

                                   {% if is_last_input %}
                                     <!-- ì™„ë£Œ: í˜„ì¬ order -->
                                     <button type="button"
                                             class="btn hit-btn-solid-primary"
                                             onclick="submitAndGo({{ input_data.order }})">
                                       í‰ê°€ ì €ì¥ ì™„ë£Œ
                                     </button>
                                   {% else %}
                                     <!-- ë‹¤ìŒ: order+1 -->
                                     <button type="button"
                                             class="btn hit-btn-outline-primary"
                                             onclick="submitAndGo({{ input_data.order|add:1 }})">
                                       ì €ì¥í•˜ê³  ë‹¤ìŒ â†’
                                     </button>
                                   {% endif %}
                            </div>
                        </div>
                        <!-- /ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
                    </div>
                    <!-- /label-card-body -->
                </div>
                <!-- /label-card -->
            </div>
            <!-- /col-md-8 -->
        </div>
        <!-- /row -->
    </form>
    <!-- /í‰ê°€ í¼ -->
</div>

{{ selected_scores|json_script:"original-scores" }}
<script>
    const originalScores = JSON.parse(document.getElementById('original-scores').textContent);
</script>
<script>
    const currentOrder = {{ input_data.order }};
    function submitAndGo(targetOrder) {
        const form = document.getElementById('evaluationForm');
        document.getElementById('data_order').value = targetOrder;

        try {
            originalScores = JSON.parse(document.getElementById('original-scores').textContent);
        } catch (e) {
            console.warn("originalScores íŒŒì‹± ì‹¤íŒ¨:", e);
        }

        const groups = new Set();
        const currentScores = {};

        form.querySelectorAll("input[type='radio'][name^='score_']").forEach(input => {
            groups.add(input.name);
            if (input.checked) {
                const labelName = input.name.replace('score_', '');
                currentScores[labelName] = input.value;
            }
        });



        // ì ìˆ˜ê°€ ëª¨ë‘ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
        for (const label of groups) {
            const key = label.replace('score_', '');
            const current = currentScores[key] || '';
            if (!current) {
                alert("âš ï¸ ëª¨ë“  í•­ëª©ì— ëŒ€í•´ ì ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
        }

        // ì´ì „ ì´ë™ì€ ë¬´ì¡°ê±´ í—ˆìš©
        if (targetOrder < currentOrder) {
            return form.submit();
        }

        // ë³€ê²½ëœ ê²½ìš°ì—ë§Œ confirm
        let changed = false;
        for (const label of groups) {
            const key = label.replace('score_', '');
            const original = originalScores[key] || '';
            const current = currentScores[key] || '';
            if (original !== current) {
                changed = true;
                break;
            }
        }

        if (changed) {
            const confirmed = confirm("ë³€ê²½ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì €ì¥í• ê¹Œìš”?");
            if (!confirmed) return;
        }

        form.submit();
    }
</script>

{% endblock %}