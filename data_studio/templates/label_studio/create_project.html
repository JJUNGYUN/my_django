{% extends 'base.html' %}

{% load markdown_extras %}
{% load custom_filters %}
{% load mathfilters %}
{% block content %}
<div class="container my-5">
  <h2 class="mb-4">ğŸ› ï¸ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</h2>

  <form method="post" novalidate>
    {% csrf_token %}
            {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="card mb-4">
            <div class="card-header">ê¸°ë³¸ ì •ë³´</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">í”„ë¡œì íŠ¸ ì œëª©</label>
                    <input type="text" name="title" class="form-control"
                        value="{{ form.title.value|default_if_none:'' }}">
                    {% if form.title.errors %}
                    <div class="text-danger small">
                        {{ form.title.errors.as_text|linebreaksbr }}
                    </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label">í”„ë¡œì íŠ¸ ì„¤ëª…</label>
                    <textarea name="description" class="form-control" rows="3" placeholder="ì„¤ëª…"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" name="start_date" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">ë§ˆê°ì¼</label>
                        <input type="date" name="end_date" class="form-control">
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‘ì—… íƒ€ì… -->
        <div class="card mb-4">
          <div class="card-header">ì‘ì—… ìœ í˜•</div>
          <div class="card-body">
            <select name="task_type" id="taskTypeSelector" class="form-select">
              <option selected disabled>ì‘ì—… ìœ í˜• ì„ íƒ</option>
              <option value="classification">ë¶„ë¥˜ (Classification)</option>
              <option value="summary">ìš”ì•½</option>
              <option value="evaluation">í‰ê°€</option>
              <option value="compare">ë¹„êµ</option>
              <option value="hierarchy">ê³„ì¸µ(Hierarchy)</option>
            </select>
          </div>
        </div>

        <!-- ì‘ì—…ì ì§€ì • -->
        <div class="card-body mb-4">
            <select name="workers" class="form-select" multiple>
                {% for user in users %}
                <option value="{{ user.id }}" {% if user.id|stringformat:"s" in selected_worker_ids %} selected {% endif%}>{{ user.username }}</option>

                {% endfor %}
            </select>
            <div class="form-text">Ctrl ë˜ëŠ” âŒ˜ í‚¤ë¡œ ì—¬ëŸ¬ ëª… ì„ íƒ</div>
            <div id="selected-workers" class="mt-2 d-flex flex-wrap gap-2"></div>

        </div>

    <!-- ë¼ë²¨ ì„¤ì • -->
    <div id="labels-dynamic" class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>ë¼ë²¨ ì„¤ì •</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-label-btn">+ ë¼ë²¨ ì¶”ê°€</button>
      </div>
      <div class="card-body" id="label-container">
        <!-- ì´ˆê¸° ë¶„ë¥˜(classification)ìš© í•œ ì¤„ ì˜ˆì‹œ (ë²„íŠ¼ í´ë¦­ ì‹œ ì¶”ê°€) -->
        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-4">
            <label class="form-label">ë ˆì´ë¸” ì´ë¦„</label>
            <input type="text" name="label_name" class="form-control" placeholder="ì˜ˆ: ê¸ì •">
          </div>
          <div class="col-md-4">
            <label class="form-label">ë ˆì´ë¸” ì„¤ëª…</label>
            <input type="text" name="label_desc" class="form-control" placeholder="ì˜ˆ: ê¸ì •ì ì¸ ë¬¸ì¥">
          </div>
          <div class="col-md-2">
            <label class="form-label">ìˆœì„œ</label>
            <input type="number" name="label_order" class="form-control" min="0" value="0">
          </div>
          <div class="col-md-2">
            <label class="form-label">ì‚­ì œ</label><br>
            <button type="button" class="btn btn-danger btn-remove-label">ì‚­ì œ</button>
          </div>
        </div>
      </div>
    </div>
    <div id="labels-hierarchy" class="card mb-4 d-none">
      <div class="card-header">ê³„ì¸µí˜• ë¼ë²¨ ì…ë ¥ (JSON)</div>
      <div class="card-body">
        <textarea name="label_hierarchy" class="form-control" rows="8"
          placeholder='ì˜ˆì‹œ: [{"name":"ëŒ€ë¶„ë¥˜A","children":[{"name":"ì¤‘ë¶„ë¥˜A1","children":[{"name":"ì†Œë¶„ë¥˜A1-1"}]}]}]'>{{ request.POST.label_hierarchy }}</textarea>
        {% if hierarchy_error %}
          <div class="text-danger mt-2">{{ hierarchy_error }}</div>
        {% endif %}
        <small class="form-text text-muted">JSON í˜•ì‹ìœ¼ë¡œ ëŒ€â†’ì¤‘â†’ì†Œâ€¦ në‹¨ê³„ ê³„ì¸µì„ ì…ë ¥</small>
      </div>
    </div>
    
    <!-- ì €ì¥ ë²„íŠ¼ -->
    <div class="text-end">
      <button type="submit" class="btn btn-success px-4">í”„ë¡œì íŠ¸ ì €ì¥</button>
    </div>
  </form>
</div>
{% endblock %}

{% block script %}
<!-- Tagify ë¡œë“œ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectBox = document.querySelector("select[name='workers']");
        const selectedContainer = document.getElementById("selected-workers");

        const selectedIds = new Set();  // ì¤‘ë³µ ë°©ì§€ìš©

        // ë”ë¸” í´ë¦­ ì‹œ ì‘ì—…ì ì¶”ê°€
        selectBox.addEventListener("dblclick", function (e) {
            const option = e.target;
            const userId = option.value;
            const userName = option.textContent;

            if (!userId || selectedIds.has(userId)) return;

            selectedIds.add(userId);

            const badge = document.createElement("div");
            badge.className = "badge bg-primary text-white p-2 d-flex align-items-center";
            badge.innerHTML = `
                <span class="me-2">${userName}</span>
                <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Remove"></button>
                <input type="hidden" name="workers" value="${userId}">
            `;

            badge.querySelector(".btn-close").addEventListener("click", function () {
                selectedContainer.removeChild(badge);
                selectedIds.delete(userId);
            });

            selectedContainer.appendChild(badge);
        });
    });
</script>
<script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const selector = document.getElementById('taskTypeSelector');
    const dyn = document.getElementById('labels-dynamic');
    const hier = document.getElementById('labels-hierarchy');
    function toggleLabelUI(){
      if(selector.value==='hierarchy'){
        dyn.classList.add('d-none');
        hier.classList.remove('d-none');
      } else {
        dyn.classList.remove('d-none');
        hier.classList.add('d-none');
      }
    }
    selector.addEventListener('change', toggleLabelUI);
    toggleLabelUI();
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const taskType = document.getElementById("taskTypeSelector");
  const addLabelBtn = document.getElementById("add-label-btn");
  const labelContainer = document.getElementById("label-container");

  // ë¶„ë¥˜ìš© row
  function createLabelRow() {
    const row = document.createElement('div');
    row.className = 'row g-3 align-items-end mb-3';
    row.innerHTML = `
      <div class="col-md-4">
        <label class="form-label">ë ˆì´ë¸” ì´ë¦„</label>
        <input type="text" name="label_name" class="form-control" placeholder="ì˜ˆ: ê¸ì •">
      </div>
      <div class="col-md-4">
        <label class="form-label">ë ˆì´ë¸” ì„¤ëª…</label>
        <input type="text" name="label_desc" class="form-control" placeholder="ì˜ˆ: ê¸ì •ì ì¸ ë¬¸ì¥">
      </div>
      <div class="col-md-2">
        <label class="form-label">ìˆœì„œ</label>
        <input type="number" name="label_order" class="form-control" min="0" value="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">ì‚­ì œ</label><br>
        <button type="button" class="btn btn-danger btn-remove-label">ì‚­ì œ</button>
      </div>
    `;
    row.querySelector('.btn-remove-label').addEventListener('click', () => row.remove());
    return row;
  }

  // í‰ê°€ìš© row (Tagify ì ìš©)
  function createEvaluationLabelRow() {
    const row = document.createElement('div');
    row.className = 'row g-3 align-items-end mb-3';
    row.innerHTML = `
      <div class="col-md-3">
        <label class="form-label">í‰ê°€ í•­ëª©</label>
        <input type="text" name="label_name" class="form-control" placeholder="ì˜ˆ: ì •í™•ì„±">
      </div>
      <div class="col-md-5">
        <label class="form-label">ì ìˆ˜ ì˜µì…˜</label>
        <input type="text" name="label_options" class="form-control tagify-input" placeholder="ì˜ˆ: 1,2,3,4,5">
      </div>
      <div class="col-md-2">
        <label class="form-label">ìˆœì„œ</label>
        <input type="number" name="label_order" class="form-control" min="0" value="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">ì‚­ì œ</label><br>
        <button type="button" class="btn btn-danger btn-remove-label">ì‚­ì œ</button>
      </div>
    `;
    row.querySelector('.btn-remove-label').addEventListener('click', () => row.remove());

    // Tagify ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const input = row.querySelector('.tagify-input');
    new Tagify(input, { delimiters: ",", dropdown: { enabled: 0 } });

    return row;
  }

  // ìœ í˜•ì— ë”°ë¼ ì´ˆê¸° UI ì„¤ì •
  function applyLabelUIByTaskType() {
    const type = taskType.value;
    labelContainer.innerHTML = '';  // ì´ˆê¸°í™”
    addLabelBtn.disabled = false;

    if (type === "classification") {
      labelContainer.appendChild(createLabelRow());
    } else if (type === "evaluation") {
      labelContainer.appendChild(createEvaluationLabelRow());
    } else if (type === "summary") {
                addLabelBtn.disabled = true;

                const fixedRow = document.createElement('div');
                fixedRow.className = 'row g-3 align-items-end mb-3';
                fixedRow.innerHTML = `
                <div class="col-md-4">
                    <label class="form-label">ë ˆì´ë¸” ì´ë¦„</label>
                    <input type="text" name="label_name" class="form-control" value="summary" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ë ˆì´ë¸” ì„¤ëª…</label>
                    <input type="text" name="label_desc" class="form-control" value="ìš”ì•½ í…ìŠ¤íŠ¸ ì…ë ¥ìš© ë¼ë²¨" readonly>
                </div>
                <div class="col-md-2">
                    <label class="form-label">ìˆœì„œ</label>
                    <input type="number" name="label_order" class="form-control" value="0" readonly>
                </div>
                <div class="col-md-2">
                    <label class="form-label">ì‚­ì œ</label><br>
                    <button type="button" class="btn btn-danger" disabled>ì‚­ì œ</button>
                </div>
            `;
                labelContainer.appendChild(fixedRow);

            } 
            else {
      // summary, compare ë“±ì€ ë³„ë„ ì²˜ë¦¬â€¦
      addLabelBtn.disabled = true;
    }
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  taskType.addEventListener("change", applyLabelUIByTaskType);
  addLabelBtn.addEventListener("click", function () {
    if (taskType.value === "classification") {
      labelContainer.appendChild(createLabelRow());
    } else if (taskType.value === "evaluation") {
      labelContainer.appendChild(createEvaluationLabelRow());
    }
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  applyLabelUIByTaskType();
});
</script>
{% endblock %}
