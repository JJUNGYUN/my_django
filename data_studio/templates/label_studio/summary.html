{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <!-- 진행도 + 현재 위치 통합 표시 -->
    <div class="label-card bg-light border-0 shadow-sm mb-4">
        <div class="label-card-body py-3 px-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h5 class="mb-0 fw-bold text-primary">{{ project.title }} 작업 진행</h5>
                    <small class="text-muted">현재 위치: <strong>{{ current_index }}</strong> / {{ total_inputs }}</small>
                </div>
                <div class="text-end">
                    <span class="text-muted me-2">진행도:</span>
                    <strong>{{ progress }}%</strong>
                </div>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%;"
                    aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                <span class="fw-bold">{{ progress }}%</span>
            </div>
        </div>
    </div>


    <form id="summaryForm" method="post" action="{% url 'label_studio:submit_work' project.id %}">
        {% csrf_token %}
        <div class="label-card">
            <!-- 헤더 -->
            <div class="label-card-header">
                <h5>{{ project.title }} – 요약 작업 {{ current_index }} / {{ total_inputs }}</h5>
            </div>

            <div class="label-card-body">
                <!-- 원문 텍스트 -->
                <p class="label-text">{{ input_data.data.input }}</p>

                <!-- 히든 필드 -->
                <input type="hidden" name="input_id" value="{{ input_data.id }}">
                <input type="hidden" name="data_order" id="data_order">

                <!-- 요약 입력 -->
                <div class="label-group mb-4">
                    <label class="label-group-title">요약 입력</label>
                    <textarea class="label-textarea" name="summary" rows="3"
                        placeholder="여기에 요약을 입력하세요…">{{ selected_summary }}</textarea>
                </div>

                <!-- 액션 버튼 그룹 -->
                <div class="d-flex justify-content-between align-items-center mt-4 gap-2">
                    {% if current_index > 1 %}
                      <!-- 이전: order-1 -->
                      <button type="button"
                              class="btn hit-btn-outline-primary"
                              onclick="submitAndGo({{ input_data.order|add:-1 }})">
                        ← 이전
                  </button>
                   {% endif %}

                 <div class="d-flex gap-2">
                     <button type="button"
                             class="btn btn-outline-success btn-sm guideline-toggle-btn"
                             onclick="toggleGuideline()">
                         📘 가이드라인 & 💬 코멘트 작성
                     </button>
                     {% include "label_studio/guide_line.html" %}

                        {% if is_last_input %}
                          <!-- 완료: 현재 order -->
                          <button type="button"
                                  class="btn hit-btn-solid-primary"
                                  onclick="submitAndGo({{ input_data.order }})">
                            평가 저장 완료
                          </button>
                        {% else %}
                          <!-- 다음: order+1 -->
                          <button type="button"
                                  class="btn hit-btn-outline-primary"
                                  onclick="submitAndGo({{ input_data.order|add:1 }})">
                            저장하고 다음 →
                          </button>
                        {% endif %}
                 </div>
             </div>
            </div>
        </div>
    </form>

</div>

{% endblock %}
{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById('summaryForm');
        if (!form) return;
    
        const summaryInput = form.querySelector('textarea[name="summary"]');
        const originalSummary = summaryInput.value.trim();
    
        // 마지막 작업 여부
        const isLast = {{ is_last_input|yesno:"true,false" }};
        // 현재 order 변수 (템플릿에서 전달)
        const currentOrder = {{ input_data.order }};
    
        window.submitAndGo = function (targetOrder) {
            const current = summaryInput.value.trim();
    
            // 요약 비어 있으면 경고
            if (!current) {
                alert("⚠️ 요약 내용을 입력해주세요.");
                return;
            }

            // 이전(순서가 작을 때): 확인 없이 바로 이동
            if (targetOrder < currentOrder) {
                document.getElementById('data_order').value = targetOrder;
                return form.submit();
            }
    
            // 변경된 경우만 confirm
            if (current !== originalSummary) {
                const msg = isLast
                    ? "입력한 요약을 저장하고 작업을 마무리할까요?"
                    : "입력한 요약을 저장하고 다음으로 이동할까요?";
                if (!confirm(msg)) return;
            }
    
            // data_order 설정 후 제출
            document.getElementById('data_order').value = targetOrder;
            form.submit();
        };
    });
    </script>
{% endblock %}