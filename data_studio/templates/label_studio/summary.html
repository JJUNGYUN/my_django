{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <!-- ì§„í–‰ë„ + í˜„ì¬ ìœ„ì¹˜ í†µí•© í‘œì‹œ -->
    <div class="label-card bg-light border-0 shadow-sm mb-4">
        <div class="label-card-body py-3 px-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h5 class="mb-0 fw-bold text-primary">{{ project.title }} ì‘ì—… ì§„í–‰</h5>
                    <small class="text-muted">í˜„ì¬ ìœ„ì¹˜: <strong>{{ current_index }}</strong> / {{ total_inputs }}</small>
                </div>
                <div class="text-end">
                    <span class="text-muted me-2">ì§„í–‰ë„:</span>
                    <strong>{{ progress }}%</strong>
                </div>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%;"
                    aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                <span class="fw-bold">{{ progress }}%</span>
            </div>
        </div>
    </div>


    <form id="summaryForm" method="post" action="{% url 'label_studio:submit_work' project.id %}">
        {% csrf_token %}
        <div class="label-card">
            <!-- í—¤ë” -->
            <div class="label-card-header">
                <h5>{{ project.title }} â€“ ìš”ì•½ ì‘ì—… {{ current_index }} / {{ total_inputs }}</h5>
            </div>

            <div class="label-card-body">
                <!-- ì›ë¬¸ í…ìŠ¤íŠ¸ -->
                <p class="label-text">{{ input_data.data.input }}</p>

                <!-- íˆë“  í•„ë“œ -->
                <input type="hidden" name="input_id" value="{{ input_data.id }}">
                <input type="hidden" name="data_order" id="data_order">

                <!-- ìš”ì•½ ì…ë ¥ -->
                <div class="label-group mb-4">
                    <label class="label-group-title">ìš”ì•½ ì…ë ¥</label>
                    <textarea class="label-textarea" name="summary" rows="3"
                        placeholder="ì—¬ê¸°ì— ìš”ì•½ì„ ì…ë ¥í•˜ì„¸ìš”â€¦">{{ selected_summary }}</textarea>
                </div>

                <!-- ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
                <div class="d-flex justify-content-between align-items-center mt-4 gap-2">
                    {% if current_index > 1 %}
                      <!-- ì´ì „: order-1 -->
                      <button type="button"
                              class="btn hit-btn-outline-primary"
                              onclick="submitAndGo({{ input_data.order|add:-1 }})">
                        â† ì´ì „
                  </button>
                   {% endif %}

                 <div class="d-flex gap-2">
                     <button type="button"
                             class="btn btn-outline-success btn-sm guideline-toggle-btn"
                             onclick="toggleGuideline()">
                         ğŸ“˜ ê°€ì´ë“œë¼ì¸ & ğŸ’¬ ì½”ë©˜íŠ¸ ì‘ì„±
                     </button>
                     {% include "label_studio/guide_line.html" %}

                        {% if is_last_input %}
                          <!-- ì™„ë£Œ: í˜„ì¬ order -->
                          <button type="button"
                                  class="btn hit-btn-solid-primary"
                                  onclick="submitAndGo({{ input_data.order }})">
                            í‰ê°€ ì €ì¥ ì™„ë£Œ
                          </button>
                        {% else %}
                          <!-- ë‹¤ìŒ: order+1 -->
                          <button type="button"
                                  class="btn hit-btn-outline-primary"
                                  onclick="submitAndGo({{ input_data.order|add:1 }})">
                            ì €ì¥í•˜ê³  ë‹¤ìŒ â†’
                          </button>
                        {% endif %}
                 </div>
             </div>
            </div>
        </div>
    </form>

</div>

{% endblock %}
{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById('summaryForm');
        if (!form) return;
    
        const summaryInput = form.querySelector('textarea[name="summary"]');
        const originalSummary = summaryInput.value.trim();
    
        // ë§ˆì§€ë§‰ ì‘ì—… ì—¬ë¶€
        const isLast = {{ is_last_input|yesno:"true,false" }};
        // í˜„ì¬ order ë³€ìˆ˜ (í…œí”Œë¦¿ì—ì„œ ì „ë‹¬)
        const currentOrder = {{ input_data.order }};
    
        window.submitAndGo = function (targetOrder) {
            const current = summaryInput.value.trim();
    
            // ìš”ì•½ ë¹„ì–´ ìˆìœ¼ë©´ ê²½ê³ 
            if (!current) {
                alert("âš ï¸ ìš”ì•½ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ì´ì „(ìˆœì„œê°€ ì‘ì„ ë•Œ): í™•ì¸ ì—†ì´ ë°”ë¡œ ì´ë™
            if (targetOrder < currentOrder) {
                document.getElementById('data_order').value = targetOrder;
                return form.submit();
            }
    
            // ë³€ê²½ëœ ê²½ìš°ë§Œ confirm
            if (current !== originalSummary) {
                const msg = isLast
                    ? "ì…ë ¥í•œ ìš”ì•½ì„ ì €ì¥í•˜ê³  ì‘ì—…ì„ ë§ˆë¬´ë¦¬í• ê¹Œìš”?"
                    : "ì…ë ¥í•œ ìš”ì•½ì„ ì €ì¥í•˜ê³  ë‹¤ìŒìœ¼ë¡œ ì´ë™í• ê¹Œìš”?";
                if (!confirm(msg)) return;
            }
    
            // data_order ì„¤ì • í›„ ì œì¶œ
            document.getElementById('data_order').value = targetOrder;
            form.submit();
        };
    });
    </script>
{% endblock %}