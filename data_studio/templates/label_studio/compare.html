{% extends 'base.html' %}
{% load custom_filters %}
{% load mathfilters %}
{% block content %}
<div class="container py-4">
    <!-- ì œëª© ë° ì§„í–‰ë„ -->

    <div class="label-card bg-light border-0 shadow-sm mb-4">
        <div class="label-card-body py-3 px-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h5 class="mb-0 fw-bold text-primary">{{ project.title }} í‰ê°€ ì‘ì—…</h5>
                    <small class="text-muted">í˜„ì¬ ìœ„ì¹˜: <strong>{{ current_index }}</strong> / {{ total_inputs }}</small>
                </div>
                <div class="text-end">
                    <span class="text-muted me-2">ì§„í–‰ë„:</span>
                    <strong>{{ progress }}%</strong>
                </div>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%;"
                    aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                    {{ progress }}%
                </div>
            </div>
        </div>
    </div>

    <!-- ì…ë ¥ ë¬¸ì¥ -->
    <div class="row mb-4">
        <div class="col">
            <div class="label-card shadow-sm border-0 bg-light">
                <div class="label-card-body">
                    <h5 class="text-primary fw-bold">ì…ë ¥ ë¬¸ì¥</h5>
                    <p class="mb-0">{{ input_data.data.input }}</p>
                </div>
            </div>
        </div>
    </div>

    <form id="compareForm" method="post" action="{% url 'label_studio:submit_work' project.id %}">
        {% csrf_token %}
        <input type="hidden" name="input_id"    value="{{ input_data.id }}">
        <input type="hidden" name="selected_output" id="selected_output">
        <input type="hidden" name="data_order"      id="data_order">
      
        <div class="row g-4 mb-4">
          {% for opt in "A,B"|split:"," %}
            <div class="col-md-6">
              <div id="card-{{ opt }}"
                   class="label-card hover-select h-100 {% if selected_output == opt %}
                     {% if opt == 'A' %}border-success{% else %}border-warning{% endif %} border-3
                   {% endif %}"
                   onclick="selectOutput('{{ opt }}')">
                <div class="{% if opt == 'A' %}label-card-header{% else %}label-card-header-sub{% endif %}">
                  <h6 class="mb-0">ì¶œë ¥ {{ opt }}</h6>
                </div>
                <div class="label-card-body">
                    {% if opt == 'A' %}
                    <p class="mb-0">{{ input_data.data.output_a }}</p>
                  {% else %}
                    <p class="mb-0">{{ input_data.data.output_b }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      
        <div class="label-actions">
          {% if current_index > 1 %}
            <!-- ì´ì „: í˜„ì¬ order - 1 -->
            <button type="button"
                    class="label-btn label-btn-secondary"
                    onclick="submitCompare({{ input_data.order|add:-1 }})">
              â† ì´ì „
            </button>
          {% else %}
            <span style="width:75px"></span>
          {% endif %}
      
          <button type="button"
                  class="btn btn-outline-success btn-sm guideline-toggle-btn"
                  onclick="toggleGuideline()">
            ğŸ“˜ ê°€ì´ë“œë¼ì¸ & ğŸ’¬ ì½”ë©˜íŠ¸ ì‘ì„±
          </button>
          {% include "label_studio/guide_line.html" %}
      
          {% if is_last_input %}
            <!-- ì™„ë£Œ: í˜„ì¬ order -->
            <button type="button"
                    class="label-btn label-btn-primary"
                    onclick="submitCompare({{ input_data.order }})">
              ì €ì¥ ì™„ë£Œ
            </button>
          {% else %}
            <!-- ë‹¤ìŒ: í˜„ì¬ order + 1 -->
            <button type="button"
                    class="label-btn label-btn-primary"
                    onclick="submitCompare({{ input_data.order|add:1 }})">
              ì €ì¥í•˜ê³  ë‹¤ìŒ â†’
            </button>
          {% endif %}
        </div>
      </form>
</div>



<style>
    .hover-select {
        transition: box-shadow 0.2s ease-in-out, transform 0.2s;
        cursor: pointer;
    }

    .hover-select:hover {
        box-shadow: 0 0 0 0.2rem rgba(2, 182, 146, 0.301);
        transform: translateY(-2px);
    }

    .border-3 {
        border-width: 3px !important;
    }
</style>


<script>
    // í˜„ì¬ orderë¥¼ JSì—ì„œë„ ì•Œê³  ìˆì–´ì•¼ ì´ì „/ë‹¤ìŒ ë¹„êµê°€ ê°€ëŠ¥
    const currentOrder = {{ input_data.order }};
    let selected = "{{ selected_output }}";
  
    function selectOutput(opt) {
      selected = opt;
      document.getElementById('selected_output').value = opt;
      document.querySelectorAll('.hover-select').forEach(el =>
        el.classList.remove('border-success','border-warning','border-3')
      );
      document.getElementById(`card-${opt}`)
        .classList.add(opt==='A' ? 'border-success' : 'border-warning','border-3');
    }
  
    function submitCompare(targetOrder) {
      const form = document.getElementById('compareForm');
      document.getElementById('data_order').value = targetOrder;
  
      // â€œë‹¤ìŒ/ì™„ë£Œâ€ì¼ ë• ë°˜ë“œì‹œ ì˜µì…˜ ì„ íƒ
      if (!selected) {
        alert("âš ï¸ ì¶œë ¥ A ë˜ëŠ” B ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
  
    // â€œì´ì „â€(targetOrder < currentOrder)ì¼ ë•ŒëŠ” ì„ íƒ ì—†ì´ ë°”ë¡œ ì œì¶œ
    if (targetOrder < currentOrder) {
        form.submit();
        return;
      }

      form.submit();
    }
  </script>
  

{% endblock %}