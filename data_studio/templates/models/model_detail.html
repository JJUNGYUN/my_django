{% extends 'base.html' %}
{% block content %}
{% load markdown_extras %}
{% load custom_filters %}
{% load mathfilters %}

<head>
    <title>{{ model.name }}</title>
</head>
{% load static %}
<link rel="stylesheet" href="{% static 'prism/prism-tomorrow.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">

<div class="container my-3">
    <section class="section-header">
        <div class="header-main">
            <h1 class="entity-title">{{ model.name }}</h1>
            <button class="copy-button" onclick="copyHiddenValue('copy-value')" aria-label="경로 복사">
                <img src="{% static 'svg/copy.svg' %}" alt="Copy" width="16" height="16">
            </button>
            <input type="hidden" id="copy-value" value="{{ model.weight_path }}">
        </div>
        <div class="header-meta">
            <div class="badge-group">
                <span class="badge-pill">{{ model.task_type }}</span>
                {% for tag in model.tag|split:"," %}
                <span class="badge-pill">{{ tag }}</span>
                {% endfor %}
            </div>
            <span class="meta-item">Author: {{ model.author.first_name }}({{ model.author.last_name }})</span>
        </div>
    </section>

    <ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="readme-tab" data-bs-toggle="tab" href="#readme" role="tab"
                aria-controls="readme" aria-selected="true">
                📄 README.md
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="files-tab" data-bs-toggle="tab" href="#file_system" role="tab"
                aria-controls="file_system" aria-selected="false">
                📁 파일 시스템
            </a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade show active p-3 markdown position-relative"
            style="overflow-y: auto; max-height: 70vh;" id="readme" role="tabpanel" aria-labelledby="readme-tab">

            <!-- 보기 모드 -->
            <div class="markdown-body" id="readme-view" style="padding-bottom: 60px;">
                {{ readme|mark|safe }}
            </div>

            <!-- 수정 모드 (초기에 숨김) -->
            <div id="readme-edit" style="display: none; padding-bottom: 60px;">
                <textarea id="readme-textarea" class="form-control" rows="20"
                    style="overflow-y: auto; resize: vertical; min-height: 400px;">{{ readme|escape }}</textarea>
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="saveReadme({{ model.id }})">저장</button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelEdit()">취소</button>
                </div>
            </div>


        </div>


        <div class="tab-pane p-3" id="file_system" role="tabpanel" aria-labelledby="file_system-tab">
            <form method="post">
                {% csrf_token %}
                {% include "partials/file_system_viewr.html" %}
            </form>
        </div>


        <div class="d-flex justify-content-between align-items-center">
            {% if request.user == model.author %}
            <div class="position-sticky bottom-0" style="z-index: 10;">
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="editReadme()">README 수정</button>
            </div>
            {% endif %}
            <div class="my-3">
                {% if request.user == model.author %}
                <a href="{% url 'models:model_modify' model.id  %}" class="btn btn-sm btn-warning">수정</a>
                <a href="#" data-uri="{% url 'models:model_delete' model.id  %}"
                    class="delete btn btn-sm btn-danger">삭제</a>
                {% endif %}
            </div>
        </div>
    </div>


</div>
{% endblock %}
{% block script %}
<script src="{% static 'prism/prism.js' %}"></script>
<script src="{% static 'prism/components/prism-python.min.js' %}"></script>
<script>

    function editReadme() {
        document.getElementById("readme-view").style.display = "none";
        document.getElementById("readme-edit").style.display = "block";
    }

    function cancelEdit() {
        document.getElementById("readme-view").style.display = "block";
        document.getElementById("readme-edit").style.display = "none";
    }

    function saveReadme(modelId) {
        const content = document.getElementById("readme-textarea").value;

        fetch(`/models/${modelId}/save_readme/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ readme: content }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();  // 또는 readme-view 내용만 갱신해도 OK
                } else {
                    alert("저장 실패: " + data.error);
                }
            });
    }

    // CSRF 토큰 가져오기
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>


<script type='text/javascript'>
    const delete_elements = document.getElementsByClassName("delete");
    Array.from(delete_elements).forEach(function (element) {
        element.addEventListener('click', function () {
            if (confirm("정말로 삭제하시겠습니까?")) {
                location.href = this.dataset.uri;
            };
        });
    });
    function copyHiddenValue(id) {
        const val = document.getElementById(id).value;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(val)
                .then(() => alert("복사 완료!"))
                .catch(err => {
                    console.error("클립보드 복사 실패:", err);
                    fallbackCopy(val);
                });
        } else {
            fallbackCopy(val);  // 지원 안될 때 대체 방식
        }
    }

    function fallbackCopy(text) {
        const tempInput = document.createElement("textarea");
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        try {
            document.execCommand("copy");
            alert("복사 완료! (fallback)");
        } catch (err) {
            alert("복사 실패 😢");
        }
        document.body.removeChild(tempInput);
    }

    window.copyHiddenValue = copyHiddenValue;

    document.addEventListener("DOMContentLoaded", function () {
        // URL hash에 따라 탭 활성화
        const hash = window.location.hash;
        if (hash) {
            const tabTrigger = document.querySelector(`a[href="${hash}"]`);
            if (tabTrigger) {
                new bootstrap.Tab(tabTrigger).show();
            }
        }

        // 탭 클릭 시 hash 갱신
        const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
        tabLinks.forEach(link => {
            link.addEventListener('shown.bs.tab', function (event) {
                history.replaceState(null, null, event.target.getAttribute('href'));
            });
        });
    });
</script>
</script>
{% endblock %}