{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-4">

  <!-- Question Header -->
  <div class="label-card mb-4">
    <div class="label-card-header text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ question.subject }}</h5>
        <small class="text-light">작성자: {{ question.author }}</small>
      </div>
    </div>
    <div class="label-card-body">
      <pre class="mb-2" style="white-space: pre-wrap; margin:0;">{{ question.content }}</pre>
      <div class="text-end">
        <small class="badge bg-light text-dark">🕒 {{ question.create_date|date:"Y-m-d H:i" }}</small>
      </div>
    </div>
  </div>

  <!-- Answer Count & New Answer Form -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0">{{ question.answer_set.count }}개의 응답</h6>
    <button class="btn hit-btn-outline-primary btn-sm" type="button"
            data-bs-toggle="collapse" data-bs-target="#answerFormCollapse"
            aria-expanded="false">
      ✍️ 답변 등록
    </button>
  </div>

  <div class="collapse mb-4" id="answerFormCollapse">
    <div class="label-card p-3">
      <form method="post" action="{% url 'pybo:answer_create' question.id %}">
        {% csrf_token %}
        {% if form.errors %}
          <div class="alert alert-danger">
            {% for field in form %}
              {% for err in field.errors %}
                <div><strong>{{ field.label }}:</strong> {{ err }}</div>
              {% endfor %}
            {% endfor %}
          </div>
        {% endif %}
        <div class="mb-3">
          <textarea name="content"
                    class="form-control"
                    rows="3"
                    placeholder="답변을 입력하세요...">{{ form.content.value }}</textarea>
        </div>
        <div class="text-end">
          <button type="submit" class="btn hit-btn-solid-primary">답변 등록</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Answers List -->
  <button class="btn hit-btn-outline-primary btn-sm mb-2" type="button"
          data-bs-toggle="collapse" data-bs-target="#answersCollapse"
          aria-expanded="true">
    💬 댓글 보기/숨기기
  </button>
  <div class="collapse show" id="answersCollapse">
    {% for answer in question.answer_set.all %}
      <div class="label-card mb-3">
        <div class="label-card-body d-flex justify-content-between align-items-start flex-wrap">
          <div class="flex-grow-1 mb-2">
            <strong>🙋 {{ answer.author }}</strong><br>
            <pre style="white-space: pre-wrap; margin:0;">{{ answer.content }}</pre>
          </div>
          <small class="text-muted">🕒 {{ answer.create_date|date:"Y-m-d H:i" }}</small>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-muted">등록된 답변이 없습니다.</p>
    {% endfor %}
  </div>

  <!-- Edit/Delete Buttons -->
  {% if request.user == question.author %}
  <div class="d-flex gap-2 mt-4">
    <a href="{% url 'pybo:question_modify' question.id %}" class="btn hit-btn-outline-primary">질문 수정</a>
    <button class="btn hit-btn-solid-red delete" data-uri="{% url 'pybo:question_delete' question.id %}">질문 삭제</button>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block script %}
<script>
  // delete confirmation
  document.querySelectorAll('.delete').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      if (confirm("정말 삭제하시겠습니까?")) {
        location.href = btn.dataset.uri;
      }
    });
  });
</script>
{% endblock %}
